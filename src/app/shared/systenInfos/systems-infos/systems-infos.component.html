<!-- Toolbar -->
<div class="grid align-items-center pt-4">
  <div class="col-12 md:col-2"></div>

  <div class="col-12 md:col-8 text-center menu">
    <h1>Catalogo de Sistemas</h1>
  </div>

  <div class="col-12 md:col-2 text-center menu">
    <p-menu #menu [model]="items" [popup]="true"></p-menu>
    <p-button [rounded]="true" [text]="true" [raised]="true" (onClick)="menu.toggle($event)"
      icon="pi pi-ellipsis-v"></p-button>
  </div>
</div>

<!-- Filtros -->
<div class="grid align-items-center search">
  <div class="col-12 md:col-4">
    <span class="p-input-icon-left w-full">
      <i class="pi pi-search"></i>
      <input pInputText class="w-full" type="text" placeholder="Buscar" [(ngModel)]="searchText"
        (ngModelChange)="onSearchChange($event)" />
    </span>
  </div>

  <div class="col-12 md:col-4">
    <p-dropdown class="w-full" [styleClass]="'env-filter ' + envClass(selectedEnv)" [options]="envOptions"
      [(ngModel)]="selectedEnv" optionLabel="label" optionValue="value" placeholder="Filtrar por Environment"
      [showClear]="true" (onChange)="onEnvChange($event.value)">
    </p-dropdown>
  </div>
</div>

<br><br>

<!-- GRID con Skeleton -->
<ng-container *ngIf="(loading$ | async) === true; else realCards">
  <div class="grid login-wrapper">
    <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let _ of [1,2,3,4,5,6,7,8]">
      <div class="surface-card border-round-xl shadow-2 p-3">
        <p-skeleton height="1.4rem" width="60%"></p-skeleton>
        <p-skeleton height="1rem" width="30%" class="mt-2"></p-skeleton>
        <p-divider class="my-3"></p-divider>
        <div class="thumb-wrap skeleton"></div>
        <p-skeleton height="2.2rem" class="mb-2" *ngFor="let __ of [1,2,3]"></p-skeleton>
        <div class="flex justify-content-between mt-3">
          <p-skeleton width="45%" height="1rem"></p-skeleton>
          <p-skeleton width="30%" height="1rem"></p-skeleton>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!-- GRID real -->
<ng-template #realCards>
  <div class="grid login-wrapper">
    <div class="col-12 sm:col-6 md:col-4 lg:col-3" *ngFor="let s of systems$ | async; trackBy: trackById">
      <div class="info-card surface-card border-round-xl shadow-2 p-3">

        <div class="header flex align-items-start justify-content-between gap-2">
          <div class="flex flex-column">
            <h3 class="m-0 line-1">{{ s.systemName }}</h3>
            <small class="text-600">{{ s.language || 'â€”' }}</small>
          </div>
          <p-tag [value]="s.devEnvironment" [severity]="envSeverity(s.devEnvironment)"></p-tag>
        </div>

        <p-divider></p-divider>

        <!-- IMAGEN -->
        <div class="thumb-wrap">
          <img [attr.src]="rawImgUrl(s.id)" (error)="onImgError($event)" loading="lazy" decoding="async" />
        </div>

        <!-- contenido central -->
        <div class="content scroll-area">
          <p class="description line-3">{{ s.objective || 'Sin objetivo' }}</p>

          <ul class="fixed-3">
            <li *ngFor="let di of (s.dataItems || []) | slice:0:3" class="mb-2">
              <strong class="line-1">{{ di.name }}</strong>
              <div class="text-600 text-sm line-1">{{ di.description }}</div>
            </li>

            <ng-container *ngIf="(s.dataItems?.length || 0) < 3">
              <li class="mb-2" *ngFor="let _ of [0, 1, 2] | slice:0:(3 - (s.dataItems?.length || 0))"
                aria-hidden="true"></li>
            </ng-container>
          </ul>
        </div>

        <!-- footer -->
        <div class="footer  flex justify-content-between text-600 text-sm pt-2 align-items-end">
          <!-- <span class="truncate">{{ s.gerencia }}</span> -->
          <span *ngIf="s.releaseDate as rd">{{ rd | date: 'dd/MM/yyyy' }}</span>
        </div>

        <!-- velo -->
        <div class="hover-veil" aria-hidden="true"></div>

        <!-- acciones -->
        <div class="hover-actions">
          <button pButton label="Info" icon="pi pi-search" size="small"
            (click)="showInfo(s.id); $event.stopPropagation()"></button>
          <button *ngIf="canEdit" pButton label="Editar" icon="pi pi-pencil" size="small"
            (click)="editSystem(s.id); $event.stopPropagation()"></button>


        </div>
      </div>
    </div>
  </div>
</ng-template>

<!-- Paginador -->
<p-paginator [rows]="(size$ | async) ?? 20" [totalRecords]="(total$ | async) ?? 0"
  [first]="(((page$ | async) ?? 1) - 1) * ((size$ | async) ?? 20)" [rowsPerPageOptions]="[20, 50, 100, 200, 300]"
  (onPageChange)="onPageChange($event)">
</p-paginator>
<p-scrollTop target="window" [threshold]="200" styleClass="custom-scrolltop" icon="pi pi-arrow-up" />
<p-toast position="bottom-right"></p-toast>